<html>
  <head>
    <script type="importmap">
      {
	"imports": {
	  "uuid": "./uuid/index.js",
	  "@yz-social/kdht": "./kdht/index.js",
	  "@yz-social/webrtc": "./webrtc/index.js"
	}
      }
    </script>
  </head>
  <body>
    <button id="update">update node display</button><pre id="display"></pre><br/>
    <input type="text" id="key" placeholder="key to read or write under"></input><br/>
    <input type="text" id="writeValue" placeholder="value to write"></input> <button id="write">write</button><br/>
    <input type="text" id="readValue" placeholder="read value" readonly></input> <button id="read">read</button><br/>    
    <script type="module">
      import { v4 as uuidv4 } from 'uuid';
      import { WebContact } from '@yz-social/kdht';
      Object.assign(globalThis, {uuidv4, WebContact });
      const bootstrapBase = new URL('/kdht', origin).href; // Must be a string
      let contact;

      async function connect() { // Connect or reconnect to the network.
	const name = uuidv4();
	contact = globalThis.contact = await WebContact.create({name});
	const bootstrapName = await contact.fetchBootstrap(bootstrapBase);
	console.log('connecting to', bootstrapName);
	const bootstrapContact = globalThis.bootstrapContact = await contact.ensureRemoteContact(bootstrapName, bootstrapBase);
	await contact.join(bootstrapContact);
	update.onclick();
      }

      update.onclick = () => {
        const report = contact.node.report(null);
        display.textContent = report;
      };
      await connect();

      write.onclick = () => contact.storeValue(key.value, writeValue.value);
      read.onclick = () => contact.node.locateValue(key.value).then(value => readValue.value = value);
      document.addEventListener("visibilitychange", () => {
	if (document.hidden) {
	  contact.disconnect();
	} else {
	  connect();
	}
      });
    </script>
  </body>    
</html>  
